<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨åª’ä½“åŠ å¯†è§£å¯†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
            max-width: 900px;
            position: relative;
        }

        .header {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border: none;
            background: transparent;
        }

        .tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 40px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #4facfe;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #4facfe;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            color: #ccc;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        input[type="password"], input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="password"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .preview-container {
            margin-top: 30px;
            text-align: center;
        }

        .media-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #c62828;
            display: none;
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2e7d32;
            display: none;
        }

        .security-info {
            background: #fff3e0;
            color: #ef6c00;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ef6c00;
            font-size: 14px;
        }

        .download-link {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 6px;
            margin-top: 15px;
            transition: background 0.3s ease;
        }

        .download-link:hover {
            background: #45a049;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” å®‰å…¨åª’ä½“åŠ å¯†ç³»ç»Ÿ</h1>
            <p>å†›ç”¨çº§AES-256åŠ å¯†ä¿æŠ¤æ‚¨çš„éšç§æ–‡ä»¶</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('encrypt')">ğŸ”’ åŠ å¯†æ–‡ä»¶</button>
            <button class="tab" onclick="switchTab('decrypt')">ğŸ”“ è§£å¯†æ–‡ä»¶</button>
        </div>

        <div class="content">
            <!-- åŠ å¯†æ ‡ç­¾é¡µ -->
            <div id="encrypt-tab" class="tab-content active">
                <div class="upload-area" onclick="document.getElementById('encrypt-file').click()">
                    <div class="upload-icon">ğŸ“</div>
                    <h3>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</h3>
                    <p>æ”¯æŒå›¾ç‰‡å’Œè§†é¢‘æ ¼å¼ (JPG, PNG, GIF, MP4, MOV, AVIç­‰)</p>
                    <input type="file" id="encrypt-file" class="file-input" accept="image/*,video/*">
                </div>

                <div class="preview-container" id="encrypt-preview"></div>

                <div class="form-group">
                    <label for="encrypt-password">è®¾ç½®åŠ å¯†å¯†ç ï¼š</label>
                    <input type="password" id="encrypt-password" placeholder="è¯·è¾“å…¥å¼ºå¯†ç ï¼ˆå»ºè®®8ä½ä»¥ä¸Šï¼‰">
                </div>

                <div class="form-group">
                    <label for="confirm-password">ç¡®è®¤å¯†ç ï¼š</label>
                    <input type="password" id="confirm-password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                </div>

                <div class="security-info">
                    ğŸ”’ <strong>å®‰å…¨æç¤ºï¼š</strong>æœ¬ç³»ç»Ÿé‡‡ç”¨AES-256åŠ å¯†ç®—æ³•ï¼Œå³ä½¿å¯†ç é”™è¯¯ä¹Ÿæ— æ³•çœ‹åˆ°æ–‡ä»¶çš„ä»»ä½•è½®å»“ä¿¡æ¯ã€‚è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„å¯†ç ï¼Œä¸¢å¤±åå°†æ— æ³•æ¢å¤æ–‡ä»¶ï¼
                </div>

                <button class="btn" onclick="encryptFile()" id="encrypt-btn" disabled>å¼€å§‹åŠ å¯†</button>

                <div class="progress-bar" id="encrypt-progress">
                    <div class="progress-fill" id="encrypt-progress-fill"></div>
                </div>

                <div class="error-message" id="encrypt-error"></div>
                <div class="success-message" id="encrypt-success"></div>
            </div>

            <!-- è§£å¯†æ ‡ç­¾é¡µ -->
            <div id="decrypt-tab" class="tab-content">
                <div class="upload-area" onclick="document.getElementById('decrypt-file').click()">
                    <div class="upload-icon">ğŸ“</div>
                    <h3>é€‰æ‹©åŠ å¯†æ–‡ä»¶ (.encrypted)</h3>
                    <p>è¯·é€‰æ‹©ä¹‹å‰åŠ å¯†çš„æ–‡ä»¶è¿›è¡Œè§£å¯†</p>
                    <input type="file" id="decrypt-file" class="file-input" accept=".encrypted">
                </div>

                <div class="form-group">
                    <label for="decrypt-password">è¾“å…¥è§£å¯†å¯†ç ï¼š</label>
                    <input type="password" id="decrypt-password" placeholder="è¯·è¾“å…¥æ­£ç¡®çš„åŠ å¯†å¯†ç ">
                </div>

                <button class="btn" onclick="decryptFile()" id="decrypt-btn" disabled>å¼€å§‹è§£å¯†</button>

                <div class="progress-bar" id="decrypt-progress">
                    <div class="progress-fill" id="decrypt-progress-fill"></div>
                </div>

                <div class="error-message" id="decrypt-error"></div>
                <div class="success-message" id="decrypt-success"></div>

                <div class="preview-container" id="decrypt-preview"></div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥CryptoJSåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let currentFile = null;
        let encryptedData = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ ç›‘å¬
            document.getElementById('encrypt-file').addEventListener('change', handleEncryptFileSelect);
            document.getElementById('decrypt-file').addEventListener('change', handleDecryptFileSelect);

            // æ‹–æ‹½ä¸Šä¼ 
            const uploadAreas = document.querySelectorAll('.upload-area');
            uploadAreas.forEach(area => {
                area.addEventListener('dragover', handleDragOver);
                area.addEventListener('drop', handleDrop);
                area.addEventListener('dragleave', handleDragLeave);
            });

            // å®æ—¶éªŒè¯
            document.getElementById('encrypt-password').addEventListener('input', validateEncryptForm);
            document.getElementById('confirm-password').addEventListener('input', validateEncryptForm);
            document.getElementById('decrypt-password').addEventListener('input', validateDecryptForm);
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // æ¸…ç©ºæ¶ˆæ¯
            clearMessages();
        }

        // å¤„ç†æ‹–æ‹½æ‚¬åœ
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        // å¤„ç†æ‹–æ‹½ç¦»å¼€
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        // å¤„ç†æ–‡ä»¶æ‹–æ”¾
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const isEncrypt = e.currentTarget.closest('#encrypt-tab');
                const fileInput = isEncrypt ? document.getElementById('encrypt-file') : document.getElementById('decrypt-file');
                fileInput.files = files;
                
                if (isEncrypt) {
                    handleEncryptFileSelect({target: {files}});
                } else {
                    handleDecryptFileSelect({target: {files}});
                }
            }
        }

        // å¤„ç†åŠ å¯†æ–‡ä»¶é€‰æ‹©
        function handleEncryptFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                currentFile = file;
                showPreview(file, 'encrypt-preview');
                validateEncryptForm();
            }
        }

        // å¤„ç†è§£å¯†æ–‡ä»¶é€‰æ‹©
        function handleDecryptFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
                if (!file.name.endsWith('.encrypted')) {
                    showError('decrypt-error', 'è¯·é€‰æ‹©æœ‰æ•ˆçš„åŠ å¯†æ–‡ä»¶(.encryptedæ ¼å¼)');
                    return;
                }
                
                currentFile = file;
                document.getElementById('decrypt-preview').innerHTML = '<p>ğŸ“„ å·²é€‰æ‹©åŠ å¯†æ–‡ä»¶: ' + file.name + '</p>';
                validateDecryptForm();
            }
        }

        // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
        function showPreview(file, containerId) {
            const container = document.getElementById(containerId);
            const url = URL.createObjectURL(file);
            
            let previewHTML = '';
            if (file.type.startsWith('image/')) {
                previewHTML = `<img src="${url}" alt="é¢„è§ˆ" class="media-preview">`;
            } else if (file.type.startsWith('video/')) {
                previewHTML = `
                    <video controls class="media-preview">
                        <source src="${url}" type="${file.type}">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                    </video>
                `;
            } else {
                previewHTML = `<p>ğŸ“„ å·²é€‰æ‹©æ–‡ä»¶: ${file.name}</p>`;
            }
            
            container.innerHTML = previewHTML;
        }

        // éªŒè¯åŠ å¯†è¡¨å•
        function validateEncryptForm() {
            const password = document.getElementById('encrypt-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const fileSelected = currentFile !== null;
            
            const isValid = fileSelected && 
                           password.length >= 6 && 
                           password === confirmPassword;
            
            document.getElementById('encrypt-btn').disabled = !isValid;
        }

        // éªŒè¯è§£å¯†è¡¨å•
        function validateDecryptForm() {
            const password = document.getElementById('decrypt-password').value;
            const fileSelected = currentFile !== null;
            
            const isValid = fileSelected && password.length > 0;
            
            document.getElementById('decrypt-btn').disabled = !isValid;
        }

        // åŠ å¯†æ–‡ä»¶ - ä¿®å¤ç‰ˆæœ¬
        async function encryptFile() {
            const password = document.getElementById('encrypt-password').value;
            const file = currentFile;
            
            if (!file || !password) {
                showError('encrypt-error', 'è¯·é€‰æ‹©æ–‡ä»¶å¹¶è®¾ç½®å¯†ç ');
                return;
            }

            try {
                showProgress('encrypt-progress', true);
                updateProgress('encrypt-progress-fill', 0);

                // è¯»å–æ–‡ä»¶ä¸ºArrayBufferç„¶åè½¬ä¸ºWordArray
                const arrayBuffer = await readFileAsArrayBuffer(file);
                const fileWords = CryptoJS.lib.WordArray.create(arrayBuffer);
                
                updateProgress('encrypt-progress-fill', 25);

                // ç”Ÿæˆéšæœºç›å€¼å’ŒIV
                const salt = CryptoJS.lib.WordArray.random(128/8);
                const iv = CryptoJS.lib.WordArray.random(128/8);
                
                // ä»å¯†ç æ´¾ç”Ÿå¯†é’¥
                const key = CryptoJS.PBKDF2(password, salt, {
                    keySize: 256/32,
                    iterations: 100000
                });
                
                updateProgress('encrypt-progress-fill', 50);

                // åŠ å¯†æ–‡ä»¶æ•°æ®
                const encrypted = CryptoJS.AES.encrypt(fileWords, key, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });
                
                updateProgress('encrypt-progress-fill', 75);

                // æ„å»ºåŠ å¯†æ–‡ä»¶ç»“æ„
                const encryptedFileData = {
                    originalName: file.name,
                    originalType: file.type,
                    originalSize: file.size,
                    salt: CryptoJS.enc.Base64.stringify(salt),
                    iv: CryptoJS.enc.Base64.stringify(iv),
                    data: encrypted.ciphertext.toString(CryptoJS.enc.Base64)
                };
                
                // è½¬æ¢ä¸ºJSONå¹¶åˆ›å»ºBlob
                const jsonString = JSON.stringify(encryptedFileData);
                const encryptedBlob = new Blob([jsonString], {
                    type: 'application/json'
                });
                
                updateProgress('encrypt-progress-fill', 100);

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(encryptedBlob);
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = file.name + '.encrypted';
                downloadLink.className = 'download-link';
                downloadLink.textContent = 'ğŸ“¥ ä¸‹è½½åŠ å¯†æ–‡ä»¶';
                
                // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                showSuccess('encrypt-success', 'æ–‡ä»¶åŠ å¯†æˆåŠŸï¼è¯·å¦¥å–„ä¿ç®¡å¯†ç å’ŒåŠ å¯†æ–‡ä»¶ã€‚');
                
                // æ·»åŠ ä¸‹è½½é“¾æ¥åˆ°é¡µé¢
                const previewContainer = document.getElementById('encrypt-preview');
                previewContainer.appendChild(downloadLink);
                
                setTimeout(() => {
                    showProgress('encrypt-progress', false);
                }, 1000);
                
            } catch (error) {
                console.error('åŠ å¯†å¤±è´¥:', error);
                showError('encrypt-error', 'åŠ å¯†å¤±è´¥ï¼š' + error.message);
                showProgress('encrypt-progress', false);
            }
        }

        // è§£å¯†æ–‡ä»¶ - å®Œå…¨ä¿®å¤ç‰ˆæœ¬
        async function decryptFile() {
            const password = document.getElementById('decrypt-password').value;
            const file = currentFile;
            
            if (!file || !password) {
                showError('decrypt-error', 'è¯·é€‰æ‹©åŠ å¯†æ–‡ä»¶å¹¶è¾“å…¥å¯†ç ');
                return;
            }

            try {
                showProgress('decrypt-progress', true);
                updateProgress('decrypt-progress-fill', 0);

                // è¯»å–åŠ å¯†æ–‡ä»¶ä¸ºæ–‡æœ¬
                const fileContent = await readFileAsText(file);
                updateProgress('decrypt-progress-fill', 25);

                // è§£æåŠ å¯†æ–‡ä»¶æ•°æ®
                const encryptedFileData = JSON.parse(fileContent);
                
                // ä»Base64è§£ç ç›å€¼å’ŒIV
                const salt = CryptoJS.enc.Base64.parse(encryptedFileData.salt);
                const iv = CryptoJS.enc.Base64.parse(encryptedFileData.iv);
                
                // ä»å¯†ç æ´¾ç”Ÿå¯†é’¥
                const key = CryptoJS.PBKDF2(password, salt, {
                    keySize: 256/32,
                    iterations: 100000
                });
                
                updateProgress('decrypt-progress-fill', 50);

                // å‡†å¤‡å¯†æ–‡æ•°æ®
                const ciphertext = CryptoJS.enc.Base64.parse(encryptedFileData.data);
                
                // åˆ›å»ºåŠ å¯†å¯¹è±¡è¿›è¡Œè§£å¯†
                const cipherParams = CryptoJS.lib.CipherParams.create({
                    ciphertext: ciphertext
                });
                
                // è§£å¯†æ•°æ®
                const decrypted = CryptoJS.AES.decrypt(cipherParams, key, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });
                
                updateProgress('decrypt-progress-fill', 75);

                // æ£€æŸ¥è§£å¯†æ˜¯å¦æˆåŠŸ
                if (decrypted.sigBytes <= 0) {
                    throw new Error('å¯†ç é”™è¯¯æˆ–æ–‡ä»¶å·²æŸå');
                }
                
                // å°†è§£å¯†åçš„WordArrayè½¬æ¢ä¸ºBlob
                const decryptedBlob = wordArrayToBlob(decrypted, encryptedFileData.originalType);
                
                // éªŒè¯æ–‡ä»¶å¤§å°æ˜¯å¦åˆç†
                if (decryptedBlob.size !== encryptedFileData.originalSize) {
                    console.warn('æ–‡ä»¶å¤§å°ä¸åŒ¹é…ï¼Œä½†ç»§ç»­å¤„ç†...');
                }
                
                updateProgress('decrypt-progress-fill', 90);

                // åˆ›å»ºBlob URLç”¨äºé¢„è§ˆå’Œä¸‹è½½
                const url = URL.createObjectURL(decryptedBlob);
                
                // æ˜¾ç¤ºè§£å¯†åçš„æ–‡ä»¶
                const previewContainer = document.getElementById('decrypt-preview');
                let previewHTML = '';
                
                if (encryptedFileData.originalType.startsWith('image/')) {
                    previewHTML = `<img src="${url}" alt="è§£å¯†é¢„è§ˆ" class="media-preview" onload="console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ')" onerror="console.error('å›¾ç‰‡åŠ è½½å¤±è´¥')">`;
                } else if (encryptedFileData.originalType.startsWith('video/')) {
                    previewHTML = `
                        <video controls class="media-preview">
                            <source src="${url}" type="${encryptedFileData.originalType}">
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                        </video>
                    `;
                } else {
                    previewHTML = `<p>ğŸ“„ æ–‡ä»¶ç±»å‹: ${encryptedFileData.originalType}</p>`;
                }
                
                previewHTML += `<p><strong>åŸå§‹æ–‡ä»¶å:</strong> ${encryptedFileData.originalName}</p>`;
                previewHTML += `<p><strong>æ–‡ä»¶å¤§å°:</strong> ${formatFileSize(decryptedBlob.size)}</p>`;
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = encryptedFileData.originalName;
                downloadLink.className = 'download-link';
                downloadLink.textContent = 'ğŸ“¥ ä¸‹è½½è§£å¯†æ–‡ä»¶';
                
                previewContainer.innerHTML = previewHTML;
                previewContainer.appendChild(downloadLink);
                
                updateProgress('decrypt-progress-fill', 100);
                showSuccess('decrypt-success', 'æ–‡ä»¶è§£å¯†æˆåŠŸï¼å¯†ç æ­£ç¡®ï¼Œå¯ä»¥æŸ¥çœ‹å®Œæ•´å†…å®¹ã€‚');
                
                setTimeout(() => {
                    showProgress('decrypt-progress', false);
                }, 1000);
                
            } catch (error) {
                console.error('è§£å¯†å¤±è´¥:', error);
                if (error.message.includes('å¯†ç é”™è¯¯æˆ–æ–‡ä»¶å·²æŸå')) {
                    showError('decrypt-error', 'âŒ å¯†ç é”™è¯¯ï¼æ— æ³•è§£å¯†æ–‡ä»¶ã€‚å³ä½¿å¯†ç æ¥è¿‘æ­£ç¡®ï¼Œä¹Ÿæ— æ³•çœ‹åˆ°ä»»ä½•å†…å®¹è½®å»“ã€‚');
                } else {
                    showError('decrypt-error', 'è§£å¯†å¤±è´¥ï¼š' + error.message);
                }
                showProgress('decrypt-progress', false);
                document.getElementById('decrypt-preview').innerHTML = '<p style="color: #999;">è§£å¯†å¤±è´¥ï¼Œæ— æ³•æ˜¾ç¤ºå†…å®¹</p>';
            }
        }

        // ä¿®å¤çš„WordArrayè½¬Blobå‡½æ•°
        function wordArrayToBlob(wordArray, mimeType) {
            // ä½¿ç”¨Base64ä½œä¸ºä¸­é—´æ ¼å¼æ¥é¿å…å­—èŠ‚åºé—®é¢˜
            const base64 = CryptoJS.enc.Base64.stringify(wordArray);
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            
            return new Blob([bytes], { type: mimeType });
        }

        // è¯»å–æ–‡ä»¶ä¸ºArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // è¯»å–æ–‡ä»¶ä¸ºæ–‡æœ¬
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file, 'utf-8');
            });
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ˜¾ç¤ºè¿›åº¦æ¡
        function showProgress(progressId, show) {
            const progressBar = document.getElementById(progressId);
            progressBar.style.display = show ? 'block' : 'none';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(fillId, percentage) {
            document.getElementById(fillId).style.width = percentage + '%';
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 8000);
        }

        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(elementId, message) {
            const successElement = document.getElementById(elementId);
            successElement.textContent = message;
            successElement.style.display = 'block';
        }

        // æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯
        function clearMessages() {
            document.querySelectorAll('.error-message, .success-message').forEach(el => {
                el.style.display = 'none';
            });
        }
    </script>
</body>
</html>
